<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QnA</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 32px auto; padding: 0 16px;}
    input[type="search"]{ width:100%; padding:10px; font-size:16px; margin-bottom:16px;}
    .item{ padding:16px 0; border-bottom:1px solid #eee;}
    .q{ font-weight:700; }
    .summary{ color:#666; margin:6px 0; white-space:pre-wrap;}
    .answer{ white-space:pre-wrap; }
    mark{ background:#fff2ac; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>QnA</h1>

  <input id="search" type="search" placeholder="검색어(질문/요약/풀버전/키워드) 입력…" />
  <div id="list">로딩 중…</div>

  <script>
    const CSV_URL = "./data/qna.csv?v=" + Date.now(); // 캐시 무력화
    const $search = document.getElementById('search');
    const $list = document.getElementById('list');

    let rows = [];

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: ({data}) => {
        rows = data.map(r => ({
          q: (r["Case"] || "").trim(),
          summary: (r["멘트-요약"] || "").trim(),
          full: (r["멘트 풀버전"] || r["멘트 풀버전, 설명"] || "").trim(),
          keywords: (r["비고"] || "").trim()
        }));
        render("");
      },
      error: (err) => {
        $list.textContent = "CSV 로드 실패: " + err;
      }
    });

    $search.addEventListener('input', e => render(e.target.value.trim()));

    function render(term){
      const kw = term.toLowerCase();

      const filtered = rows.filter(r => {
        const hay = [r.q, r.summary, r.full, r.keywords].join(" ").toLowerCase();
        return !kw || hay.includes(kw);
      });

      $list.innerHTML = filtered.map(r => `
        <div class="item">
          <div class="q">Q. ${hl(esc(r.q), term)}</div>
          ${r.summary ? `<div class="summary">${hl(esc(r.summary), term)}</div>` : ""}
          ${r.full ? `<div class="answer">${hl(esc(r.full), term)}</div>` : ""}
          ${r.keywords ? `<div style="margin-top:8px; font-size:13px; color:#888;">키워드: ${hl(esc(r.keywords), term)}</div>` : ""}
        </div>
      `).join('') || `<p>검색 결과가 없습니다.</p>`;
    }

    // 유틸: 하이라이트 & XSS 방지
    function hl(text, term){
      if(!term) return text;
      const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return text.replace(new RegExp(`(${esc})`, 'gi'), '<mark>$1</mark>');
    }
    function esc(str){ return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>
