<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QnA</title>
  <style>
    :root { --shadow: 0 6px 24px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; max-width: 900px; margin: 32px auto; padding: 0 16px;}
    .search-wrap { position: relative; }
    #search { width:100%; padding:12px 14px; font-size:16px; border:1px solid #ddd; border-radius:10px; }
    .suggest { position:absolute; top:110%; left:0; right:0; background:#fff; border:1px solid #e7e7e7; border-radius:10px; box-shadow: var(--shadow); z-index: 10; max-height: 320px; overflow:auto; display:none; }
    .suggest-item { padding:10px 12px; cursor:pointer; }
    .suggest-item strong { font-weight:700; }
    .suggest-item:hover, .suggest-item.active { background:#f6f6f6; }
    .item{ padding:16px 0; border-bottom:1px solid #eee;}
    .q{ font-weight:700; } /* 라벨 없이 굵게만 */
    .summary{ color:#666; margin:6px 0; white-space:pre-wrap;}
    .answer{ white-space:pre-wrap; }
    mark{ background:#fff2ac; }
    .muted{ color:#9aa0a6; font-size:13px; margin:12px 0;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>QnA</h1>

  <div class="search-wrap">
    <input id="search" type="search" placeholder="키워드나 내용을 입력하면 자동 완성됩니다…" autocomplete="off" />
    <div id="suggest" class="suggest" role="listbox" aria-label="자동완성"></div>
  </div>

  <div id="hint" class="muted">검색어를 입력해 보세요.</div>
  <div id="list"></div>

  <script>
    const CSV_URL = "./data/qna.csv?v=" + Date.now(); // 캐시 무력화
    const $search = document.getElementById('search');
    const $list = document.getElementById('list');
    const $suggest = document.getElementById('suggest');
    const $hint = document.getElementById('hint');

    let rows = [];
    let suggestions = [];    // 자동완성 풀(질문 + 비고 키워드)
    let activeIndex = -1;    // 키보드 탐색용

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: ({data}) => {
        rows = data.map(r => ({
          q: (r["Case"] || "").trim(),
          summary: (r["멘트-요약"] || "").trim(),
          full: (r["멘트 풀버전"] || r["멘트 풀버전, 설명"] || "").trim(),
          keywords: (r["비고"] || "").trim()
        }));

        // 자동완성 후보 만들기: 질문(Case) + 키워드(비고: / 구분)
        const set = new Set();
        rows.forEach(r => {
          if (r.q) set.add(r.q);
          if (r.keywords) r.keywords.split("/").map(s=>s.trim()).filter(Boolean).forEach(k => set.add(k));
        });
        suggestions = Array.from(set);
      },
      error: (err) => {
        $list.textContent = "CSV 로드 실패: " + err;
      }
    });

    // 디바운스
    let t = null;
    $search.addEventListener('input', e => {
      const term = e.target.value.trim();
      clearTimeout(t);
      t = setTimeout(() => {
        showSuggest(term);
        render(term);
      }, 80);
    });

    // 자동완성 렌더
    function showSuggest(term){
      activeIndex = -1;
      if (!term) { $suggest.style.display='none'; return; }
      const lower = term.toLowerCase();
      const items = suggestions
        .filter(s => s.toLowerCase().includes(lower))
        .slice(0, 12);

      if (!items.length) { $suggest.style.display='none'; return; }

      $suggest.innerHTML = items.map((s,i) => `
        <div class="suggest-item" role="option" data-value="${escAttr(s)}">${hl(esc(s), term)}</div>
      `).join('');
      $suggest.style.display='block';
    }

    // 자동완성 마우스 선택
    $suggest.addEventListener('click', e => {
      const el = e.target.closest('.suggest-item');
      if (!el) return;
      pickSuggestion(el.getAttribute('data-value'));
    });

    // 자동완성 키보드 탐색
    $search.addEventListener('keydown', e => {
      const open = $suggest.style.display === 'block';
      if (!open) return;
      const items = [...$suggest.querySelectorAll('.suggest-item')];
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1) % items.length;
        updateActive(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        updateActive(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeIndex >= 0) {
          pickSuggestion(items[activeIndex].getAttribute('data-value'));
        } else {
          // 그냥 현재 입력으로 검색
          $suggest.style.display='none';
        }
      } else if (e.key === 'Escape') {
        $suggest.style.display='none';
      }
    });

    function updateActive(items){
      items.forEach((el,i)=>el.classList.toggle('active', i===activeIndex));
      if (activeIndex>=0) items[activeIndex].scrollIntoView({block:'nearest'});
    }

    function pickSuggestion(value){
      $search.value = value;
      $suggest.style.display='none';
      render(value);
    }

    function render(term){
      const kw = (term || "").toLowerCase();

      const filtered = !kw ? [] : rows.filter(r => {
        const hay = [r.q, r.summary, r.full, r.keywords].join(" ").toLowerCase();
        return hay.includes(kw);
      });

      if (!term) {
        $hint.style.display = 'block';
      } else {
        $hint.style.display = 'none';
      }

      $list.innerHTML = filtered.map(r => `
        <div class="item">
          <div class="q">${hl(esc(r.q), term)}</div>
          ${r.summary ? `<div class="summary">${hl(esc(r.summary), term)}</div>` : ""}
          ${r.full ? `<div class="answer">${hl(esc(r.full), term)}</div>` : ""}
        </div>
      `).join('');
    }

    // 유틸: 하이라이트 & XSS 방지
    function hl(text, term){
      if(!term) return text;
      const escRe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return text.replace(new RegExp(`(${escRe})`, 'gi'), '<mark>$1</mark>');
    }
    function esc(str){ return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escAttr(str){ return esc(str).replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
