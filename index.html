<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QnA</title>
  <style>
    :root { --shadow: 0 6px 24px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; max-width: 900px; margin: 32px auto; padding: 0 16px;}
    h1 { margin: 0 0 16px; }
    .search-wrap { position: relative; }
    #search { width:100%; padding:12px 14px; font-size:16px; border:1px solid #ddd; border-radius:10px; }
    .suggest { position:absolute; top:110%; left:0; right:0; background:#fff; border:1px solid #e7e7e7; border-radius:10px; box-shadow: var(--shadow); z-index: 10; max-height: 320px; overflow:auto; display:none; }
    .suggest-item { padding:10px 12px; cursor:pointer; }
    .suggest-item strong { font-weight:700; }
    .suggest-item:hover, .suggest-item.active { background:#f6f6f6; }
    .muted{ color:#9aa0a6; font-size:13px; margin:12px 0;}
    .item{ padding:16px 0; border-bottom:1px solid #eee;}
    .q{ font-weight:700; }             /* 질문: Q. 라벨 없이 굵게만 */
    .summary{ color:#666; margin:6px 0; white-space:pre-wrap;}
    .answer{ white-space:pre-wrap; }
    mark{ background:#fff2ac; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>QnA</h1>

  <div class="search-wrap">
    <input id="search" type="search" placeholder="키워드나 내용을 입력하면 자동 완성됩니다…" autocomplete="off" />
    <div id="suggest" class="suggest" role="listbox" aria-label="자동완성"></div>
  </div>

  <div id="hint" class="muted">검색어를 입력해 보세요.</div>
  <div id="list"></div>

  <script>
    const CSV_URL = "./data/qna.csv?v=" + Date.now(); // 캐시 무력화
    const $search = document.getElementById('search');
    const $list = document.getElementById('list');
    const $suggest = document.getElementById('suggest');
    const $hint = document.getElementById('hint');

    let rows = [];
    let suggestions = [];      // 자동완성 후보 (Case + 비고)
    let activeIndex = -1;      // 자동완성 키보드 탐색 인덱스

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',                      // 공백 줄 제거
      // 헤더 정규화: BOM 제거 + 공백 정규화
      transformHeader(h) {
        return String(h)
          .replace(/^\uFEFF/, '')                    // BOM 제거
          .replace(/\s+/g, ' ')                      // 연속 공백 하나로
          .trim();
      },
      complete: ({data}) => {
        // 안전 컬럼 접근
        const get = (obj, candidates) => {
          const keys = Object.keys(obj);
          // 1) 정확 일치
          for (const name of candidates) {
            if (obj[name] != null) return String(obj[name]).trim();
          }
          // 2) 공백/구두점 제거 후 유사 일치
          const norm = s => s.replace(/\s|,|·|\.|，|、/g,'');
          for (const k of keys) {
            for (const name of candidates) {
              if (norm(k) === norm(name)) return String(obj[k]).trim();
            }
          }
          return "";
        };

        // CSV → 내부 모델 매핑 (4컬럼)
        rows = data.map(r => ({
          q:        get(r, ["Case"]),
          summary:  get(r, ["멘트-요약"]),
          full:     get(r, ["멘트 풀버전", "멘트 풀버전, 설명"]),
          keywords: get(r, ["비고"])
        })).filter(r => r.q || r.summary || r.full || r.keywords);

        // 자동완성 후보 구성: 질문 + 비고(/로 분리)
        const set = new Set();
        rows.forEach(r => {
          if (r.q) set.add(r.q);
          if (r.keywords) r.keywords.split("/").map(s=>s.trim()).filter(Boolean).forEach(k => set.add(k));
        });
        suggestions = Array.from(set);
      },
      error: (err) => {
        $list.textContent = "CSV 로드 실패: " + err;
      }
    });

    // ===== 입력 이벤트 (디바운스) =====
    let t = null;
    $search.addEventListener('input', e => {
      const term = e.target.value.trim();
      clearTimeout(t);
      t = setTimeout(() => {
        showSuggest(term);
        render(term);
      }, 80);
    });

    // ===== 자동완성 렌더 =====
    function showSuggest(term){
      activeIndex = -1;
      if (!term) { $suggest.style.display='none'; return; }
      const lower = term.toLowerCase();
      const items = suggestions
        .filter(s => s.toLowerCase().includes(lower))
        .slice(0, 12);

      if (!items.length) { $suggest.style.display='none'; return; }

      $suggest.innerHTML = items.map((s,i) => `
        <div class="suggest-item" role="option" data-value="${escAttr(s)}">${hl(esc(s), term)}</div>
      `).join('');
      $suggest.style.display='block';
    }

    // 마우스로 자동완성 선택
    $suggest.addEventListener('click', e => {
      const el = e.target.closest('.suggest-item');
      if (!el) return;
      pickSuggestion(el.getAttribute('data-value'));
    });

    // 키보드 탐색 (↑/↓/Enter/Esc)
    $search.addEventListener('keydown', e => {
      const open = $suggest.style.display === 'block';
      if (!open) return;
      const items = [...$suggest.querySelectorAll('.suggest-item')];
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1) % items.length;
        updateActive(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        updateActive(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeIndex >= 0) {
          pickSuggestion(items[activeIndex].getAttribute('data-value'));
        } else {
          $suggest.style.display='none'; // 현재 입력으로 검색 확정
        }
      } else if (e.key === 'Escape') {
        $suggest.style.display='none';
      }
    });

    function updateActive(items){
      items.forEach((el,i)=>el.classList.toggle('active', i===activeIndex));
      if (activeIndex>=0) items[activeIndex].scrollIntoView({block:'nearest'});
    }

    function pickSuggestion(value){
      $search.value = value;
      $suggest.style.display='none';
      render(value);
    }

    // ===== 결과 렌더 =====
    function render(term){
      const kw = (term || "").toLowerCase();
      const filtered = !kw ? [] : rows.filter(r => {
        const hay = [r.q, r.summary, r.full, r.keywords].join(" ").toLowerCase();
        return hay.includes(kw);
      });

      $hint.style.display = term ? 'none' : 'block';

      $list.innerHTML = filtered.map(r => `
        <div class="item">
          <div class="q">${hl(esc(r.q), term)}</div>
          ${r.summary ? `<div class="summary">${hl(esc(r.summary), term)}</div>` : ""}
          ${r.full ? `<div class="answer">${hl(esc(r.full), term)}</div>` : ""}
        </div>
      `).join('');
    }

    // ===== 유틸: 하이라이트 & XSS 방지 =====
    function hl(text, term){
      if(!term) return text;
      const escRe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return text.replace(new RegExp(`(${escRe})`, 'gi'), '<mark>$1</mark>');
    }
    function esc(str){ return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escAttr(str){ return esc(str).replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
